{"data":{"site":{"siteMetadata":{"title":"Christian Vuerings","author":"Christian Vuerings"}},"markdownRemark":{"id":"119ceae8-e728-5e72-bc61-a1ebc0ccae95","excerpt":"Some Sakai3 front-end developers had a dream: For our widget loading mechanism we want to load the HTML / CSS and JavaScript in one request (without asking the…","html":"<p>Some Sakai3 front-end developers had a dream:</p>\n<blockquote>\n<p>For our widget loading mechanism we want to load the HTML / CSS and JavaScript in one request (without asking the user to use inline CSS or JavaScript)</p>\n</blockquote>\n<p>It felt like quite a big challenge and I wondered if it would be possible from a front-end point of view or not. So I <a href=\"https://christianvuerings.github.io/everythingatonce/\">gave it a go</a>.</p>\n<h3>What we need from the back-end</h3>\n<p>In Nakamura (the Sakai3 back-end) we are using <a href=\"https://sling.apache.org/site/index.html\">Apache Sling</a> in combination with <a href=\"https://jackrabbit.apache.org/\">Apache Jackrabbit</a>. Which means that when we go to a URL like twitter.2.json we get information back about the structure of it’s contents:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"jcr:createdBy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"jcr:created\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Mon Apr 19 2010 11:08:18 GMT+0100\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"jcr:primaryType\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"sling:Folder\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"css\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"jcr:createdBy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"jcr:created\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Mon Apr 19 2010 11:08:18 GMT+0100\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"jcr:primaryType\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"sling:Folder\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"twitter.css\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"jcr:createdBy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"jcr:created\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Mon Apr 19 2010 11:08:18 GMT+0100\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"jcr:primaryType\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"nt:file\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"javascript\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"jcr:createdBy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"jcr:created\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Mon Apr 19 2010 11:08:18 GMT+0100\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"jcr:primaryType\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"sling:Folder\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"twitter.js\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"jcr:createdBy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"jcr:created\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Mon Apr 19 2010 11:08:18 GMT+0100\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"jcr:primaryType\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"nt:file\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"twitter.html\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"jcr:createdBy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"jcr:created\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Mon Apr 19 2010 11:08:18 GMT+0100\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"jcr:primaryType\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"nt:file\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"jcr:content\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"jcr:lastModifiedBy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\":jcr:data\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2465</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"jcr:primaryType\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"nt:resource\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"jcr:uuid\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"65305673-e757-4ff8-a62a-26f10b11a020\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"jcr:mimeType\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"text/html\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"jcr:lastModified\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Mon Apr 19 2010 11:07:54 GMT+0100\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If we remove all the “jcr:” properties on those nodes, it makes it even more clear:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"css\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"twitter.css\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"javascript\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"twitter.js\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"twitter.html\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We basically get the hierarchical folder structure back for the twitter widget. If we change default GET servlet for sling or if we make a URL to something like twitter.content.json, it would be possible to get something like this back:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"css\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"twitter.css\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"content\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"body {background:#000000}\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"javascript\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"twitter.js\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"content\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"alert(\\\"loaded\\\");\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"twitter.html\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"content\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"&lt;!DOCTYPE html>&lt;html lang=\\\"en\\\">&lt;head>&lt;meta http-equiv=\\\"Content-type\\\" content=\\\"text/html; charset=utf-8\\\">&lt;title>Loaded page&lt;/title>&lt;link rel=\\\"stylesheet\\\" href=\\\"css/twitter.css\\\" type=\\\"text/css\\\" />&lt;script type=\\\"text/javascript\\\" src=\\\"javascript/twitter.js\\\">&lt;/script>&lt;/head>&lt;body>&lt;h1>Testing whether this could actually work&lt;/h1>&lt;/body>&lt;/html>\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And that, would be genuinely awesome. This would mean that our widget could be loaded into one request! Except for the images – but those could get base64 encoded…</p>\n<h3>About the example</h3>\n<p>Before I send a request to the back-end to have this feature enabled, I want to make sure that we could actually make it work in cross-browser, fast and easy to use way.</p>\n<p>Basically a Sakai3 page process looks like this:</p>\n<ol>\n<li>Load a Sakai3 page with all it’s resources (HTML / CSS / JavaScript / Images)</li>\n<li>When this page is loaded, load all the widgets you embedded on that page.</li>\n</ol>\n<p>The Sakai3 widget process goes a bit deeper:</p>\n<ol>\n<li>For each widget type, send one GET request to it’s path. (e.g. devwidgets/twitter.3.json)</li>\n<li>Run over all the properties in that file and divide it into 3 sections: HTML / CSS and JavaScript.</li>\n<li>Save those 3 sections in separate objects / arrays in the JavaScript memory.</li>\n<li>Remove the original &#x3C;link> and &#x3C;script> tags from the widget HTML.</li>\n<li>Add the widget HTML to the container on the Sakai3 page.</li>\n<li>Load the CSS and JavaScript dynamically without doing an extra request.</li>\n</ol>\n<p>So instead of doing a request to an <a href=\"https://christianvuerings.github.io/everythingatonce/loaded.html\">HTML file</a>, a <a href=\"https://christianvuerings.github.io/everythingatonce/css/loaded.css\">CSS file</a> and a <a href=\"https://christianvuerings.github.io/everythingatonce/javascript/loaded.js\">JavaScript file</a>, we would just make one request to a <a href=\"https://christianvuerings.github.io/everythingatonce/json/widget.json\">JSON file</a>.</p>\n<p><a href=\"./2010-04-25-perf1_b.png\">\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 300px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 10%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsSAAALEgHS3X78AAAAeElEQVQI1xXGQQ6CMBBAUe6/8SImxoS40CVdVB2CUuzAOO1oadJaPYTwFj+/EvG3bpVSHhFTzsystRbv+4etAa507FpDRONbDQatcSHE8im/b6mcc6pRixjj8muZWwBE7M3g51nC8yWBvT3dN/vdod42lzOgRZqmPwzCZAc3PaE8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Doing the requests separately\"\n        title=\"\"\n        src=\"/static/b45f7ec554a5713f7684248c0ff3d3b4/56ac3/2010-04-25-perf1.png\"\n        srcset=\"/static/b45f7ec554a5713f7684248c0ff3d3b4/3dd37/2010-04-25-perf1.png 148w,\n/static/b45f7ec554a5713f7684248c0ff3d3b4/3dede/2010-04-25-perf1.png 295w,\n/static/b45f7ec554a5713f7684248c0ff3d3b4/56ac3/2010-04-25-perf1.png 300w\"\n        sizes=\"(max-width: 300px) 100vw, 300px\"\n      />\n    </span>\n  </span>\n  </a></p>\n<p>vs.</p>\n<p><a href=\"./2010-04-25-perf2_b.png\">\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 300px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 1.6666666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAIAAABR8BlyAAAACXBIWXMAAAsSAAALEgHS3X78AAAAN0lEQVQI12M4c/bM+bPnz5w6f+H8hUuXLj148OjDh/e3b90+ffLU7dt3Pn369O7du/dgAGfAAQAhnzURxDCFkQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Doing everything in one request\"\n        title=\"\"\n        src=\"/static/f3834399e740aaa15566c67758c9731b/56ac3/2010-04-25-perf2.png\"\n        srcset=\"/static/f3834399e740aaa15566c67758c9731b/3dd37/2010-04-25-perf2.png 148w,\n/static/f3834399e740aaa15566c67758c9731b/3dede/2010-04-25-perf2.png 295w,\n/static/f3834399e740aaa15566c67758c9731b/56ac3/2010-04-25-perf2.png 300w\"\n        sizes=\"(max-width: 300px) 100vw, 300px\"\n      />\n    </span>\n  </span>\n  </a></p>\n<p>Too be honest I got everything working quite fast (+/- 1,5 hour) but it took a bit longer to make everything cross-browser. Especially the last part, loading the JavaScript and CSS dynamically.</p>\n<p>I knew jQuery just recently added the <a href=\"https://api.jquery.com/jQuery.getScript/\">$.getScript</a> but that added an extra Ajax call which I wanted to avoid in the first place. After lurking through the jQuery API and <a href=\"https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js\">source code</a>, I found out that the <a href=\"https://api.jquery.com/jQuery.globalEval/\">$.globalEval</a> function did exactly what I wanted for the JavaScript part.</p>\n<p>Maybe I didn’t look well enough, but I actually couldn’t find any native jQuery method that would load the CSS dynamically. So I wrote something that is heavily based on <a href=\"https://www.phpied.com/dynamic-script-and-style-elements-in-ie/\">a post</a> by <a href=\"https://www.phpied.com/\">Stoyan Stephanov</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> head <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span><span class=\"token string\">'head'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">item</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> tag <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;link/>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ntag<span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span>attributes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>tagname <span class=\"token operator\">===</span> <span class=\"token string\">\"style\"</span> <span class=\"token operator\">&amp;&amp;</span> tag<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>styleSheet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    tag<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>styleSheet<span class=\"token punctuation\">.</span>cssText <span class=\"token operator\">=</span> content<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\n    tag<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\nhead<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>All the code that I wrote so far is pretty much WIP and in non-development ready state. For instance at the moment I load all the CSS/JavaScript files I get back from the JSON where I should only use the ones defined in the HTML. That and some other little things still need to be fixed. But those are minor things though and I definitely think I have an awesome proof of concept.</p>","frontmatter":{"title":"Loading Everything at Once - HTML, CSS & JavaScript","date":"April 25, 2010"}}},"pageContext":{"slug":"/loading-everything-at-once-javascript-html-css/","previous":null,"next":{"fields":{"slug":"/hacking-around-with-userscripts/"},"frontmatter":{"title":"Hacking Around With Userscripts"}}}}